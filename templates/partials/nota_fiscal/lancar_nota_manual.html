{% load static %}
{% load widget_tweaks %}

<main id="main-content" class="container-fluid py-4" data-page="lancar-nota-manual">
  <!-- container de alerts via JS -->
  <div id="mensagens"></div>

  <div class="card shadow-sm mx-auto" style="max-width: 1200px;">
    <div class="card-body">
      <h2 class="mb-4 text-center">Lançar Nota Fiscal Manualmente</h2>

      <form id="form-lancar-nota" action="{% url 'nota_fiscal:lancar_nota_manual' %}" method="post" class="ajax-form">
        {% csrf_token %}

        <!-- Dados da Nota Fiscal (Cabeçalho) -->
        <fieldset class="mb-4 p-3 border rounded">
          <legend class="float-none w-auto px-2">Dados da Nota Fiscal</legend>
          <div class="row g-3">
            {% for field in form %}
              <div class="col-md-6">
                <label for="{{ field.id_for_label }}" class="form-label">
                  {{ field.label }}
                </label>
                {% render_field field class="form-control" %}
                {% if field.errors %}
                  <div class="invalid-feedback d-block">
                    {{ field.errors }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </fieldset>

        <!-- Itens da Nota Fiscal (Formset) -->
        <fieldset class="mb-4 p-3 border rounded">
          <legend class="float-none w-auto px-2">Itens da Nota Fiscal</legend>
          <div id="formset-container">
            {{ formset.management_form }}
            {% for item_form in formset %}
              <div class="item-formset row g-3 mb-3 p-3 border rounded bg-light">
                {% for field in item_form %}
                  <div class="col-md-4">
                    <label for="{{ field.id_for_label }}" class="form-label">
                      {{ field.label }}
                    </label>
                    {% render_field field class="form-control" %}
                    {% if field.errors %}
                      <div class="invalid-feedback d-block">
                        {{ field.errors }}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
                <div class="col-md-12 text-end">
                  <button type="button" class="btn btn-danger btn-sm remove-item-formset">Remover Item</button>
                </div>
              </div>
            {% endfor %}
          </div>
          <button type="button" id="add-item-formset" class="btn btn-info btn-sm mt-3">Adicionar Item</button>
        </fieldset>

        <!-- Botões de Ação -->
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success me-2">Salvar Nota Fiscal</button>
          <a href="{% url 'nota_fiscal:entradas_nota' %}" class="btn btn-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addItemButton = document.getElementById('add-item-formset');
    const totalForms = document.querySelector('#id_itens-TOTAL_FORMS');

    addItemButton.addEventListener('click', function() {
      const currentForms = document.querySelectorAll('.item-formset').length;
      const newForm = formsetContainer.children[0].cloneNode(true); // Clone the first form

      newForm.querySelectorAll('input, select, textarea').forEach(input => {
        const name = input.name.replace(/itens-(\d+)-/, `itens-${currentForms}-`);
        const id = input.id.replace(/id_itens-(\d+)-/, `id_itens-${currentForms}-`);
        input.name = name;
        input.id = id;
        input.value = ''; // Clear values for new form
      });

      formsetContainer.appendChild(newForm);
      totalForms.value = parseInt(totalForms.value) + 1;
    });

    formsetContainer.addEventListener('click', function(event) {
      if (event.target.classList.contains('remove-item-formset')) {
        if (document.querySelectorAll('.item-formset').length > 1) {
          event.target.closest('.item-formset').remove();
          totalForms.value = parseInt(totalForms.value) - 1;
          // Re-index forms after removal (optional, but good practice)
          document.querySelectorAll('.item-formset').forEach((form, index) => {
            form.querySelectorAll('input, select, textarea').forEach(input => {
              const name = input.name.replace(/itens-(\d+)-/, `itens-${index}-`);
              const id = input.id.replace(/id_itens-(\d+)-/, `id_itens-${index}-`);
              input.name = name;
              input.id = id;
            });
          });
        } else {
          alert("Você precisa ter pelo menos um item na nota fiscal.");
        }
      }
    });
  });
</script>