{% load static %}

<main id="main-content" class="container-fluid py-4" data-page="lancar-nota-manual">
  <!-- container de alerts via JS -->
  <div id="mensagens"></div>

  <div class="card shadow-sm mx-auto" style="max-width: 1200px;">
    <div class="card-body">
      <h2 class="mb-4 text-center">Lançar Nota Fiscal Manualmente</h2>

      <form id="form-lancar-nota" class="ajax-form">
        {% csrf_token %}

        <!-- Dados da Nota Fiscal (Cabeçalho) -->
        <fieldset class="mb-4 p-3 border rounded">
          <legend class="float-none w-auto px-2">Dados da Nota Fiscal</legend>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="id_chave_acesso" class="form-label">Chave de Acesso</label>
              <input type="text" id="id_chave_acesso" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="id_numero" class="form-label">Número da Nota</label>
              <input type="text" id="id_numero" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="id_natureza_operacao" class="form-label">Natureza da Operação</label>
              <input type="text" id="id_natureza_operacao" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="id_data_emissao" class="form-label">Data de Emissão</label>
              <input type="datetime-local" id="id_data_emissao" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="id_data_saida" class="form-label">Data de Saída/Entrada</label>
              <input type="datetime-local" id="id_data_saida" class="form-control">
            </div>
            <div class="col-md-12">
              <label for="id_informacoes_adicionais" class="form-label">Informações Adicionais</label>
              <textarea id="id_informacoes_adicionais" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </fieldset>

        <!-- Dados do Emitente -->
        <fieldset class="mb-4 p-3 border rounded">
          <legend class="float-none w-auto px-2">Dados do Emitente</legend>
          <div class="mb-3 text-end">
            <button type="button" class="btn btn-primary btn-sm" id="btn_selecionar_emitente">Selecionar Emitente</button>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="id_emit_cnpj" class="form-label">CNPJ</label>
              <input type="text" id="id_emit_cnpj" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_xNome" class="form-label">Razão Social</label>
              <input type="text" id="id_emit_xNome" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_xFant" class="form-label">Nome Fantasia</label>
              <input type="text" id="id_emit_xFant" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_ie" class="form-label">Inscrição Estadual</label>
              <input type="text" id="id_emit_ie" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_logradouro" class="form-label">Logradouro</label>
              <input type="text" id="id_emit_logradouro" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_numero" class="form-label">Número</label>
              <input type="text" id="id_emit_numero" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_bairro" class="form-label">Bairro</label>
              <input type="text" id="id_emit_bairro" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_cidade" class="form-label">Cidade</label>
              <input type="text" id="id_emit_cidade" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_uf" class="form-label">UF</label>
              <input type="text" id="id_emit_uf" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_emit_cep" class="form-label">CEP</label>
              <input type="text" id="id_emit_cep" class="form-control">
            </div>
          </div>
        </fieldset>

        <!-- Dados do Destinatário -->
        <fieldset class="mb-4 p-3 border rounded">
          <legend class="float-none w-auto px-2">Dados do Destinatário</legend>
          <div class="mb-3 text-end">
            <button type="button" class="btn btn-primary btn-sm" id="btn_selecionar_destinatario">Selecionar Destinatário</button>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="id_dest_cnpj" class="form-label">CNPJ</label>
              <input type="text" id="id_dest_cnpj" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_cpf" class="form-label">CPF</label>
              <input type="text" id="id_dest_cpf" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_xNome" class="form-label">Nome / Razão Social</label>
              <input type="text" id="id_dest_xNome" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_ie" class="form-label">Inscrição Estadual</label>
              <input type="text" id="id_dest_ie" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_logradouro" class="form-label">Logradouro</label>
              <input type="text" id="id_dest_logradouro" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_numero" class="form-label">Número</label>
              <input type="text" id="id_dest_numero" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_bairro" class="form-label">Bairro</label>
              <input type="text" id="id_dest_bairro" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_cidade" class="form-label">Cidade</label>
              <input type="text" id="id_dest_cidade" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_uf" class="form-label">UF</label>
              <input type="text" id="id_dest_uf" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="id_dest_cep" class="form-label">CEP</label>
              <input type="text" id="id_dest_cep" class="form-control">
            </div>
          </div>
        </fieldset>

        <!-- Itens da Nota Fiscal -->
        <fieldset class="mb-4 p-3 border rounded">
          <legend class="float-none w-auto px-2">Itens da Nota Fiscal</legend>
          <div id="itens-container"></div>
          <button type="button" id="add-item-produto" class="btn btn-info btn-sm mt-3">Adicionar Item</button>
        </fieldset>

        <!-- Botões de Ação -->
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success me-2">Salvar Nota Fiscal</button>
          <a href="{% url 'nota_fiscal:entradas_nota' %}" class="btn btn-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</main>

<!-- Modais de Seleção de Empresa -->
<!-- Modal Emitente -->
<div class="modal fade" id="modalSelecionarEmitente" tabindex="-1" aria-labelledby="modalSelecionarEmitenteLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content modal-selecao-empresa" data-bs-theme="dark">
      <div class="modal-header">
        <h5 class="modal-title" id="modalSelecionarEmitenteLabel">Selecionar Emitente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="text" class="form-control" id="search_emitente_input" placeholder="Buscar por CNPJ, CPF ou Nome...">
        </div>
        <div id="emitente_search_results" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="select_emitente_btn" disabled>Selecionar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Destinatário -->
<div class="modal fade" id="modalSelecionarDestinatario" tabindex="-1" aria-labelledby="modalSelecionarDestinatarioLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content modal-selecao-empresa" data-bs-theme="dark">
      <div class="modal-header">
        <h5 class="modal-title" id="modalSelecionarDestinatarioLabel">Selecionar Destinatário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="text" class="form-control" id="search_destinatario_input" placeholder="Buscar por CNPJ, CPF ou Nome...">
        </div>
        <div id="destinatario_search_results" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="select_destinatario_btn" disabled>Selecionar</button>
      </div>
    </div>
  </div>
</div>

<!-- Injeção de JSON de categorias (causa parse seguro) -->
<script id="categorias-disponiveis-data" type="application/json">
  {{ categorias_disponiveis_json|default:'[]'|safe }}
</script>

<!-- Injeção de JSON de empresas (causa parse seguro) -->
<script id="empresas-disponiveis-data" type="application/json">
  {{ empresas_disponiveis_json|default:'[]'|safe }}
</script>

<script defer src="{% static 'js/lancar_nota_manual.js' %}"></script>
