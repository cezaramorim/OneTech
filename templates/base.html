{% load static %}
<!DOCTYPE html>

<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>OneTech - Painel</title>
  <link rel="shortcut icon" href="{% static 'icons/favicon.ico' %}" type="image/x-icon">

  <!-- üåô Aplica o tema escuro antes do CSS para evitar piscar -->
  <script>
    const tema = localStorage.getItem("tema");
    if (tema === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
    document.documentElement.classList.add("theme-ready");
  </script>

  <!-- üöÄ Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  

  <!-- Select2 CSS (depois do Bootstrap) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  
  <!-- üé® Estilo Customizado -->
  <link href="{% static 'css/styles.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'layout_switcher/css/switcher.css' %}">
</head>
<body class="{% if request.user.is_authenticated %}logged-in{% endif %}" id="page-body">
  <script>window.pageInitializers = {};</script> <!-- ‚úÖ Garante que o objeto global exista -->
  
  {% include 'layout_switcher/navbar.html' %}
  
  <!-- ‚úÖ Container para Toasts (mensagens instant√¢neas) -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11;">
    <!-- Toasts ser√£o injetados aqui pelo JavaScript -->
  </div>

  {% if request.user.is_authenticated %}
  
  <div class="layout d-flex">
    <!-- üìö Menu lateral -->
    <aside class="sidebar p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{% url 'painel:home' %}" class="logo d-inline-block ajax-link">
          <img src="{% static 'icons/logo_sidbar.png' %}" alt="OneTech" class="img-fluid" style="max-height: 70px;">
        </a>
        <div>
          <button id="btn-toggle-tema" class="btn btn-sm btn-outline-secondary" title="Tema">üåô</button>
          <button id="hamburger-toggle" class="btn btn-sm btn-outline-secondary d-md-none" title="Menu">‚ò∞</button>
        </div>
      </div>

      <nav>
        <div class="accordion" id="menuAccordion">
      
          {% for item in dynamic_menu_items %}
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#submenu-{{ forloop.counter }}">
                  {{ item.icon }} {{ item.name }}
                </button>
              </h2>
              <div id="submenu-{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                <div class="accordion-body p-0">
                  <ul class="list-group list-group-flush">
                    {% for child in item.children %}
                      {% if child.children %}
                        <!-- Submenu de segundo n√≠vel (ex: Usu√°rios, Grupos) -->
                        <li class="list-group-item ms-3">
                          <button class="btn w-100 text-start p-0" data-bs-toggle="collapse" data-bs-target="#submenu-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                            {{ child.icon }} {{ child.name }}
                          </button>
                          <ul id="submenu-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="collapse list-group list-group-flush mt-2 ms-3">
                            {% for grandchild in child.children %}
                              <li><a href="{{ grandchild.url }}" class="list-group-item ajax-link">{{ grandchild.name }}</a></li>
                            {% endfor %}
                          </ul>
                        </li>
                      {% else %}
                        <!-- Link direto no primeiro n√≠vel (ex: Cadastrar Empresa) -->
                        <li><a href="{{ child.url }}" class="list-group-item ajax-link">{{ child.icon }} {{ child.name }}</a></li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          {% endfor %}
      
          <!-- üë§ Perfil -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#submenu-perfil">
                üë§ Perfil
              </button>
            </h2>
            <div id="submenu-perfil" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
              <ul class="list-group list-group-flush">
                <li><a href="{% url 'accounts:edit_profile' %}" class="list-group-item ajax-link">Editar Perfil</a></li>
                {% include 'layout_switcher/control.html' %}
                <li>
                  <form method="post" action="{% url 'accounts:logout' %}" class="px-3 py-1">
                    {% csrf_token %}
                    <button type="submit" class="w-100 text-start bg-transparent border-0 logout-link">Sair</button>
                  </form>
                </li>
              </ul>
            </div>
          </div>
      
        </div> <!-- fecha .accordion -->
      </nav>
      
    </aside>

    

    <!-- üßæ Conte√∫do Principal -->
    <main id="main-content"
          class="content flex-grow-1 bg-light"
          role="main"
          data-page="{{ data_page|default:data_tela }}"
          data-tela="{{ data_tela }}">
     
      {% if content_template %}
        {% include content_template %}
      {% else %}
        <!-- ‚úÖ Tela de boas-vindas -->
        <div class="container-fluid py-5 d-flex flex-column align-items-center justify-content-center" style="min-height: 100vh;">
          <div class="card shadow-lg border-0 p-4 text-center" style="max-width: 720px; width: 100%;">
            <h2>Ol√°, <strong>{{ request.user.get_full_name }}</strong></h2>
            <p>Bem-vindo(a) ao OneTech.</p>
          </div>
        </div>

        <!-- üåÖ Imagem de fundo -->
        <div id="welcome-screen" class="home-background"></div>
      {% endif %}
    </main>
  </div> <!-- fecha .layout.d-flex -->
  {% else %}
    {# Para usu√°rios n√£o autenticados, renderiza apenas o conte√∫do #}
    {% if content_template %}
      {% include content_template %}
    {% endif %}
  {% endif %}


  <!-- üîå JavaScript Global -->

  <!-- ‚úÖ jQuery (sem defer, necess√°rio antes de outros scripts) -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <!-- ‚úÖ SweetAlert2 para mensagens -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- ‚úÖ Bootstrap Bundle (JS do Bootstrap 5) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ‚úÖ colResizable para redimensionar colunas de tabela -->
  <script src="https://cdn.jsdelivr.net/npm/colresizable@1.6.0/colResizable-1.6.min.js"></script>

  <!-- üß© Plugins e auxiliares -->
  <script src="{% static 'layout_switcher/js/layout_switcher.js' %}"></script>     {# Respons√°vel por alternar layouts #}
  <script src="{% static 'js/importar_xml.js' %}"></script>                         {# Define window.initImportarXml #}

  <!-- üß† Scripts principais do sistema -->
  <script src="{% static 'js/scripts.js' %}"></script>                              {# Core do sistema: AJAX, mensagens, navega√ß√£o #}
  <script src="{% static 'js/permissions.js' %}"></script>                          {# Comportamento da tela de permiss√µes #}

  <!-- üéØ Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>

  <!-- üìå Bloco adicional para scripts espec√≠ficos de p√°ginas -->
  {% block extra_js %}
    <script defer src="{% static 'js/relatorios/notas_entradas.js' %}"></script>
  {% endblock %}


</body>

</html>
