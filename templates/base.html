{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OneTech - Painel</title>

  <!-- ğŸš€ Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- ğŸ¨ Estilo Customizado -->
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body id="page-body" class="{% if request.user.is_authenticated %}logged-in{% endif %}">

  <!-- ğŸŒ™ Aplicar tema escuro salvo no localStorage -->
  <script>
    (() => {
      const tema = localStorage.getItem('tema');
      if (tema === 'escuro') {
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark');
      }
    })();
  </script>

  <div class="layout d-flex">

    <!-- âœ… Alertas do Django -->
    {% if messages %}
      <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3" style="width: 90%; max-width: 600px;">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- ğŸ“š Menu lateral com permissÃµes -->
    <aside class="sidebar p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <!--<a href="{% url 'painel:home' %}" class="logo text-primary fs-4 ajax-link">OneTech</a>-->
        <a href="{% url 'painel:home' %}" class="logo d-inline-block ajax-link">
          <img src="{% static 'icons/logo_sidbar.png' %}" alt="OneTech" class="img-fluid" style="max-height: 70px;">
        </a>        
        <div>
          <button id="theme-toggle" class="btn btn-sm btn-outline-secondary" title="Tema">ğŸŒ™</button>
          <button id="hamburger-toggle" class="btn btn-sm btn-outline-secondary d-md-none" title="Menu">â˜°</button>
        </div>
      </div>

      <nav>
        <div class="accordion" id="menuAccordion">          
          <!-- âš™ï¸ ConfiguraÃ§Ãµes -->
          {% if perms.accounts.view_user or perms.auth.view_group %}
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#submenu-configuracoes">
                âš™ï¸ ConfiguraÃ§Ãµes
              </button>
            </h2>
            <div id="submenu-configuracoes" class="accordion-collapse collapse">
              <div class="accordion-body p-0">
                <ul class="list-group list-group-flush">
          
                  <!-- ğŸ‘¤ UsuÃ¡rios -->
                  {% if perms.accounts.view_user %}
                  <li class="list-group-item ms-3">
                    <button class="btn w-100 text-start p-0 " data-bs-toggle="collapse" data-bs-target="#config-usuarios" aria-expanded="false">
                      ğŸ‘¤ UsuÃ¡rios
                    </button>
                    <ul id="config-usuarios" class="collapse list-group list-group-flush mt-2 ms-3">
                      {% if perms.accounts.add_user %}
                        <li><a href="{% url 'accounts:signup' %}" class="list-group-item ajax-link">Novo</a></li>
                      {% endif %}
                      <li><a href="{% url 'accounts:lista_usuarios' %}" class="list-group-item ajax-link">Lista</a></li>
                      {% if perms.accounts.change_permission %}
                        <li><a href="{% url 'accounts:selecionar_usuario_permissoes' %}" class="list-group-item ajax-link">PermissÃµes</a></li>
                      {% endif %}
                    </ul>
                  </li>
                  {% endif %}
          
                  <!-- ğŸ›¡ï¸ Grupos -->
                  {% if perms.auth.view_group %}
                  <li class="list-group-item ms-3">
                    <button class="btn w-100 text-start p-0 " data-bs-toggle="collapse" data-bs-target="#config-grupos" aria-expanded="false">
                      ğŸ›¡ï¸ Grupos
                    </button>
                    <ul id="config-grupos" class="collapse list-group list-group-flush mt-2 ms-3">
                      {% if perms.auth.add_group %}
                        <li><a href="{% url 'accounts:cadastrar_grupo' %}" class="list-group-item ajax-link">Novo</a></li>
                      {% endif %}
                      <li><a href="{% url 'accounts:lista_grupos' %}" class="list-group-item ajax-link">Lista</a></li>
                    </ul>
                  </li>
                  {% endif %}
          
                  <!-- ğŸ” PermissÃµes -->
                  {% if perms.auth.change_permission %}
                  <li class="list-group-item ms-3">
                    <button class="btn w-100 text-start p-0 " data-bs-toggle="collapse" data-bs-target="#config-permissoes" aria-expanded="false">
                      ğŸ” PermissÃµes
                    </button>
                    <ul id="config-permissoes" class="collapse list-group list-group-flush mt-2 ms-3">
                      <li><a href="{% url 'accounts:gerenciar_permissoes_geral' %}" class="list-group-item ajax-link">Gerenciar</a></li>
                      <li><a href="{% url 'accounts:gerenciar_permissoes_grupo_selector' %}" class="list-group-item ajax-link">Por Grupo</a></li>
                    </ul>
                  </li>
                  {% endif %}
          
                </ul>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ğŸ¢ Empresas -->
          {% if perms.empresas.view_empresa %}
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#submenu-empresas">ğŸ¢ Empresas</button>
            </h2>
            <div id="submenu-empresas" class="accordion-collapse collapse">
              <ul class="list-group list-group-flush">
                {% if perms.empresas.add_empresa %}
                  <li><a href="{% url 'empresas:cadastrar_empresa' %}" class="list-group-item ajax-link">Cadastrar Empresa</a></li>
                {% endif %}
                <li><a href="{% url 'empresas:lista_empresas' %}" class="list-group-item ajax-link">Lista de Empresas</a></li>
                {% if perms.empresas.add_categoria %}
                  <li><a href="{% url 'empresas:cadastrar_categoria' %}" class="list-group-item ajax-link">Categorias</a></li>
                {% endif %}
              </ul>
            </div>
          </div>
          {% endif %}

          <!-- âš™ï¸ PermissÃµes -->
          {% if perms.auth.change_permission %}
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#submenu-permissoes">âš™ï¸ PermissÃµes</button>
            </h2>
            <div id="submenu-permissoes" class="accordion-collapse collapse">
              <ul class="list-group list-group-flush">
                <li><a href="{% url 'accounts:gerenciar_permissoes_geral' %}" class="list-group-item ajax-link">Gerenciar PermissÃµes Gerais</a></li>
                <li><a href="{% url 'accounts:gerenciar_permissoes_grupo_selector' %}" class="list-group-item ajax-link">Gerenciar PermissÃµes por Grupo</a></li>
              </ul>
            </div>
          </div>
          {% endif %}

          <!-- ğŸ‘¤ Perfil -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#submenu-perfil">ğŸ‘¤ Perfil</button>
            </h2>
            <div id="submenu-perfil" class="accordion-collapse collapse">
              <ul class="list-group list-group-flush">
                <li><a href="{% url 'accounts:edit_profile' %}" class="list-group-item ajax-link">Editar Perfil</a></li>
                <li>
                  <form method="post" action="{% url 'accounts:logout' %}" class="px-3 py-1">
                    {% csrf_token %}
                    <button type="submit" class="w-100 text-start bg-transparent border-0 text-light logout-link">Sair</button>
                  </form>                                                                               
                </li>                
              </ul>
            </div>
          </div>

        </div>
      </nav>
    </aside>

    <!-- ğŸ§¾ ConteÃºdo Principal -->
    <main id="main-content"
          class="content p-4 flex-grow-1 bg-light"
          role="main"
          data-tela="{% if '/accounts/grupos/' in request.path and '/ver-permissoes/' in request.path %}
                        visualizar-permissoes-grupo
                      {% elif '/accounts/grupos/' in request.path and '/permissoes/' in request.path %}
                        gerenciar-permissoes-grupo
                      {% elif '/accounts/permissoes/por-grupo/' in request.path %}
                        gerenciar-permissoes-grupo-selector
                      {% elif '/accounts/grupos/' in request.path %}
                        lista-grupos
                      {% else %}
                        {{ request.resolver_match.url_name }}
                      {% endif %}">
      {% if content_template %}
        {% include content_template %}
      {% else %}
        <div class="welcome-bar border-bottom border-dashed mb-4 py-2 px-3">
          {% if request.user.is_authenticated %}
            OlÃ¡, <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>, bem-vindo(a) ao OneTech!
          {% else %}
            <em>Bem-vindo(a) ao OneTech!</em>
          {% endif %}
        </div>
        <div class="home-background"></div>
      {% endif %}
    </main>
  </div>

  <!-- ğŸ”Œ JavaScript Global -->
  <script src="{% static 'js/scripts.js' %}" defer></script>
</body>
</html>
